<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="x-ua-compatible" content="ie=edge" />
        <title>Leaflet-WebView2 test</title>
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
        />

        <link rel="stylesheet" href="main.css" />
        <!-- Leaflet stuff -->
        <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
            integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
            crossorigin=""
        />
        <script
            src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
            integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA=="
            crossorigin=""
        ></script>
        <script
            src="https://unpkg.com/esri-leaflet@2.2.3/dist/esri-leaflet.js"
            integrity="sha512-YZ6b5bXRVwipfqul5krehD9qlbJzc6KOGXYsDjU9HHXW2gK57xmWl2gU6nAegiErAqFXhygKIsWPKbjLPXVb2g=="
            crossorigin=""
        ></script>
    </head>

    <body>
        <div id="map_container">
            <div id="map"></div>
        </div>
        <div>
            <button
                type="button"
                style="display: flex; align-items: center"
                onClick="sendMessageToDotnet('sent from js button');"
            >
                send message
            </button>
        </div>

        <script>
            const DEFAULT_LAT = 33.95;
            const DEFAULT_LNG = -83.383333;
            const DEFAULT_ZOOM = 13;

            // catchments
            const URL_NP21_CATCHMENTS =
                "https://watersgeo.epa.gov/arcgis/rest/services/NHDPlus_NP21/Catchments_NP21_Simplified/MapServer/0";
            // WBD - HUC_8
            const URL_NP21_HUC8 =
                "https://watersgeo.epa.gov/arcgis/rest/services/NHDPlus_NP21/WBD_NP21_Simplified/MapServer/2";
            // flowlines
            const URL_NP21_FLOWLINES =
                "https://watersgeo.epa.gov/arcgis/rest/services/NHDPlus_NP21/NHDSnapshot_NP21/MapServer/0";

            // build base map layer
            const map = L.map("map").setView(
                [DEFAULT_LAT, DEFAULT_LNG],
                DEFAULT_ZOOM
            );
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution:
                    'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            }).addTo(map);

            // build map layers
            const catchments_layer = L.esri
                .featureLayer({
                    url: URL_NP21_CATCHMENTS,
                })
                .addTo(map);
            catchments_layer.setStyle({
                color: "orange",
                fillOpacity: 0,
            });

            const boundaries_layer = L.esri
                .featureLayer({
                    url: URL_NP21_HUC8,
                })
                .addTo(map);
            boundaries_layer.setStyle({
                color: "red",
                fillOpacity: 0,
            });

            const flowlines_layer = L.esri
                .featureLayer({
                    url: URL_NP21_FLOWLINES,
                })
                .addTo(map);

            const overlayMaps = {
                "HUC8 Boundaries": boundaries_layer,
                Catchments: catchments_layer,
                "Flow Lines": flowlines_layer,
            };
            const layer_options = L.control.layers(null, overlayMaps);
            layer_options.addTo(map);

            // app interaction
            function handleMapClick(e) {
                const latlng = e.latlng;
                sendMessageToDotnet(
                    `sent from map click lat: ${latlng.lat}, lng: ${latlng.lng}`
                );
            }
            map.on("click", handleMapClick);

            // dotnet <=> js message handlers
            window.chrome.webview.addEventListener("message", (event) => {
                console.log(`message from dotnet: ${event.data}`);
            });

            function sendMessageToDotnet(message) {
                window.chrome.webview.postMessage(message);
            }
        </script>
    </body>
</html>
